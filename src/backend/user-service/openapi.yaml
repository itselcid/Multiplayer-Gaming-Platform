openapi: 3.0.0
info:
  title: User Management API
  description: REST API for user authentication, management, and 2FA with role-based access control.
  version: 1.1.0
  contact:
    name: API Support

servers:
  - url: http://localhost:3000/api
    description: Development server

tags:
  - name: Authentication
    description: User authentication (Login, Register, Refresh, OAuth, 2FA Verify)
  - name: TwoFactor
    description: Two-Factor Authentication Management (Setup, Confirm, Disable)
  - name: Users
    description: User profile management
  - name: Friends
    description: Friendship management

components:
  securitySchemes:
    cookieAuth:
      type: apiKey
      in: cookie
      name: authToken
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:
    User:
      type: object
      properties:
        id:
          type: integer
        username:
          type: string
        email:
          type: string
          format: email
        avatar:
          type: string
          nullable: true
        twoFactor:
          type: object
          nullable: true
          properties:
            method:
              type: string
              enum: [email, totp]
      example:
        id: 1
        username: johndoe
        email: john@example.com
        twoFactor: { method: "email" }


    UserSearch:
      type: object
      properties:
        id: { type: integer }
        username: { type: string }
        avatar: { type: string }

    LoginRequest:
      type: object
      required: [username, password]
      properties:
        username: { type: string }
        password: { type: string, format: password }

    RegisterRequest:
      type: object
      required: [username, email, password]
      properties:
        username: { type: string, minLength: 4 }
        email: { type: string, format: email }
        password: { type: string, minLength: 4 }

    Verify2FARequest:
      type: object
      required: [code]
      properties:
        code: 
          type: string
          description: 6-digit verification code

    Setup2FARequest:
      type: object
      required: [method, password]
      properties:
        method:
          type: string
          enum: [email, totp]
        password:
          type: string
          description: Current password for verification

    Confirm2FARequest:
      type: object
      required: [code]
      properties:
        code: { type: string }

    Disable2FARequest:
      type: object
      required: [password]
      properties:
        password: { type: string }

    Error:
      type: object
      properties:
        error: { type: string }

    Friend:
      type: object
      properties:
        id: { type: integer }
        username: { type: string }
        avatar: { type: string }

paths:
  /auth/login:
    post:
      tags: [Authentication]
      summary: Login user
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LoginRequest'
      responses:
        '200':
          description: Login successful (or 2FA required)
          content:
            application/json:
              schema:
                type: object
                properties:
                  message: { type: string }
                  requires2FA: { type: boolean }
                  user: 
                    $ref: '#/components/schemas/User'
                  devCode: 
                    type: string
                    description: Development only code (if 2FA required)
        '401':
          description: Invalid credentials

  /auth/login/verify:
    post:
      tags: [Authentication]
      summary: Verify 2FA code during login
      security:
        - cookieAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/Verify2FARequest'
      responses:
        '200':
          description: 2FA Verified, full session granted
          content:
            application/json:
              schema:
                type: object
                properties:
                  message: { type: string }
                  user:
                    $ref: '#/components/schemas/User'

  /auth/register:
    post:
      tags: [Authentication]
      summary: Register new user
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RegisterRequest'
      responses:
        '201':
          description: User registered
        '400':
          description: Validation error

  /auth/refresh:
    post:
      tags: [Authentication]
      summary: Refresh Access Token
      description: Uses the httpOnly refreshToken cookie to issue a new authToken.
      responses:
        '200':
          description: Token refreshed
          content:
            application/json:
              schema:
                type: object
                properties:
                  message: { type: string }
                  user:
                    $ref: '#/components/schemas/User'
        '401':
          description: Invalid or missing refresh token

  /auth/logout:
    post:
      tags: [Authentication]
      summary: Logout user
      description: Clears auth cookies
      responses:
        '200':
          description: Logout successful

  /users/me:
    get:
      tags: [Users]
      summary: Get current user profile
      security:
        - cookieAuth: []
      responses:
        '200':
          content:
            application/json:
              schema:
                type: object
                properties:
                  user:
                    $ref: '#/components/schemas/User'

  /users/me/avatar:
    post:
      tags: [Users]
      summary: Upload user avatar
      security:
        - cookieAuth: []
      requestBody:
        content:
          multipart/form-data:
            schema:
              type: object
              properties:
                file:
                  type: string
                  format: binary
      responses:
        '200':
          description: Avatar uploaded successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message: { type: string }
                  user:
                    $ref: '#/components/schemas/User'

  /users:
    get:
      tags: [Users]
      summary: Get all users
      security:
        - cookieAuth: []
      responses:
        '200':
          content:
            application/json:
              schema:
                type: object
                properties:
                  users:
                    type: array
                    items:
                      $ref: '#/components/schemas/User'

  /users/search:
    get:
      tags: [Users]
      summary: Search users by username
      security:
        - cookieAuth: []
      parameters:
        - in: query
          name: username
          required: true
          schema:
            type: string
            minLength: 4
            maxLength: 20
      responses:
        '200':
          content:
            application/json:
              schema:
                type: object
                properties:
                  users:
                    type: array
                    items:
                      $ref: '#/components/schemas/UserSearch'

  /users/istaken:
    post:
      tags: [Users]
      summary: Check if username is taken
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [username]
              properties:
                username:
                  type: string
                  minLength: 3
                  maxLength: 16
      responses:
        '200':
          description: Username is available
          content:
            application/json:
              schema:
                type: object
                properties:
                  message: { type: string }
        '409':
          description: Username is already taken
          content:
            application/json:
              schema:
                type: object
                properties:
                  message: { type: string }

  /2fa/setup:
    post:
      tags: [TwoFactor]
      summary: Initialize 2FA Setup
      security:
        - cookieAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/Setup2FARequest'
      responses:
        '200':
          description: Setup initialized. Returns QR code (TOTP) or sends Email.
          content:
            application/json:
              schema:
                type: object
                properties:
                  message: { type: string }
                  method: { type: string }
                  secret: { type: string }
                  qrCode: { type: string }
                  devCode: { type: string }

    delete:
      tags: [TwoFactor]
      summary: Disable 2FA
      security:
        - cookieAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/Disable2FARequest'
      responses:
        '200':
          description: 2FA disabled successfully

  /2fa/confirm:
    post:
      tags: [TwoFactor]
      summary: Confirm and Enable 2FA
      security:
        - cookieAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/Confirm2FARequest'
      responses:
        '200':
          description: 2FA enabled successfully

  /friends:
    get:
      tags: [Friends]
      summary: Get all friends
      security:
        - cookieAuth: []
      responses:
        '200':
          content:
            application/json:
              schema:
                type: object
                properties:
                  friends:
                    type: array
                    items:
                      $ref: '#/components/schemas/Friend'

  /friends/requests/received:
    get:
      tags: [Friends]
      summary: Get received friend requests
      security:
        - cookieAuth: []
      responses:
        '200':
          content:
            application/json:
              schema:
                type: object
                properties:
                  friends:
                    type: array
                    items:
                      $ref: '#/components/schemas/Friend'

  /friends/requests/sent:
    get:
      tags: [Friends]
      summary: Get sent friend requests
      security:
        - cookieAuth: []
      responses:
        '200':
          content:
            application/json:
              schema:
                type: object
                properties:
                  friends:
                    type: array
                    items:
                      $ref: '#/components/schemas/Friend'

  /friends/requests/send/{friendId}:
    put:
      tags: [Friends]
      summary: Send a friend request
      security:
        - cookieAuth: []
      parameters:
        - in: path
          name: friendId
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Request sent
        '400':
          description: Invalid request (self, existing friendship)
        '404':
          description: User not found

  /friends/requests/accept/{friendId}:
    put:
      tags: [Friends]
      summary: Accept a friend request
      security:
        - cookieAuth: []
      parameters:
        - in: path
          name: friendId
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Request accepted
        '404':
          description: Request not found

  /friends/requests/reject/{friendId}:
    post:
      tags: [Friends]
      summary: Reject a friend request
      security:
        - cookieAuth: []
      parameters:
        - in: path
          name: friendId
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Request rejected

  /friends/remove/{friendId}:
    delete:
      tags: [Friends]
      summary: Remove a friend
      security:
        - cookieAuth: []
      parameters:
        - in: path
          name: friendId
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Friend removed

  /friends/block/{friendId}:
    put:
      tags: [Friends]
      summary: Block a user
      security:
        - cookieAuth: []
      parameters:
        - in: path
          name: friendId
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: User blocked

  /friends/unblock/{friendId}:
    put:
      tags: [Friends]
      summary: Unblock a user
      security:
        - cookieAuth: []
      parameters:
        - in: path
          name: friendId
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: User unblocked

  /friends/blocked:
    get:
      tags: [Friends]
      summary: Get blocked users
      security:
        - cookieAuth: []
      responses:
        '200':
          content:
            application/json:
              schema:
                type: object
                properties:
                  friends:
                    type: array
                    items:
                      $ref: '#/components/schemas/Friend'
