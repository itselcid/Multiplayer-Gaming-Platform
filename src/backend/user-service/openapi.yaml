openapi: 3.0.0
info:
  title: User Management API
  description: REST API for user authentication, management, and 2FA with role-based access control.
  version: 1.1.0
  contact:
    name: API Support

servers:
  - url: http://localhost:3000/api
    description: Development server

tags:
  - name: Authentication
    description: User authentication (Login, Register, Refresh, OAuth, 2FA Verify)
  - name: TwoFactor
    description: Two-Factor Authentication Management (Setup, Confirm, Disable)
  - name: Users
    description: User profile management
  - name: Admin
    description: Admin-only user management

components:
  securitySchemes:
    cookieAuth:
      type: apiKey
      in: cookie
      name: authToken
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:
    User:
      type: object
      properties:
        id:
          type: integer
        username:
          type: string
        email:
          type: string
          format: email
        avatar:
          type: string
          nullable: true
        twoFactor:
          type: object
          nullable: true
          properties:
            method:
              type: string
              enum: [email, totp]
        role:
          type: string
          enum: [user, admin]
      example:
        id: 1
        username: johndoe
        email: john@example.com
        twoFactor: { method: "email" }
        role: user

    LoginRequest:
      type: object
      required: [username, password]
      properties:
        username: { type: string }
        password: { type: string, format: password }

    RegisterRequest:
      type: object
      required: [username, email, password]
      properties:
        username: { type: string, minLength: 4 }
        email: { type: string, format: email }
        password: { type: string, minLength: 4 }

    Verify2FARequest:
      type: object
      required: [code]
      properties:
        code: 
          type: string
          description: 6-digit verification code

    Setup2FARequest:
      type: object
      required: [method, password]
      properties:
        method:
          type: string
          enum: [email, totp]
        password:
          type: string
          description: Current password for verification

    Confirm2FARequest:
      type: object
      required: [code]
      properties:
        code: { type: string }

    Disable2FARequest:
      type: object
      required: [password]
      properties:
        password: { type: string }

    Error:
      type: object
      properties:
        error: { type: string }

paths:
  /auth/login:
    post:
      tags: [Authentication]
      summary: Login user
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LoginRequest'
      responses:
        '200':
          description: Login successful (or 2FA required)
          content:
            application/json:
              schema:
                type: object
                properties:
                  message: { type: string }
                  requires2FA: { type: boolean }
                  user: 
                    $ref: '#/components/schemas/User'
                  devCode: 
                    type: string
                    description: Development only code (if 2FA required)
        '401':
          description: Invalid credentials

  /auth/login/verify:
    post:
      tags: [Authentication]
      summary: Verify 2FA code during login
      security:
        - cookieAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/Verify2FARequest'
      responses:
        '200':
          description: 2FA Verified, full session granted
          content:
            application/json:
              schema:
                type: object
                properties:
                  message: { type: string }
                  user:
                    $ref: '#/components/schemas/User'

  /auth/register:
    post:
      tags: [Authentication]
      summary: Register new user
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RegisterRequest'
      responses:
        '201':
          description: User registered
        '400':
          description: Validation error

  /auth/refresh:
    post:
      tags: [Authentication]
      summary: Refresh Access Token
      description: Uses the httpOnly refreshToken cookie to issue a new authToken.
      responses:
        '200':
          description: Token refreshed
          content:
            application/json:
              schema:
                type: object
                properties:
                  message: { type: string }
                  user:
                    $ref: '#/components/schemas/User'
        '401':
          description: Invalid or missing refresh token

  /auth/logout:
    post:
      tags: [Authentication]
      summary: Logout user
      description: Clears auth cookies
      responses:
        '200':
          description: Logout successful

  /users/me:
    get:
      tags: [Users]
      summary: Get current user profile
      security:
        - cookieAuth: []
      responses:
        '200':
          content:
            application/json:
              schema:
                type: object
                properties:
                  user:
                    $ref: '#/components/schemas/User'

  /2fa/setup:
    post:
      tags: [TwoFactor]
      summary: Initialize 2FA Setup
      security:
        - cookieAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/Setup2FARequest'
      responses:
        '200':
          description: Setup initialized. Returns QR code (TOTP) or sends Email.
          content:
            application/json:
              schema:
                type: object
                properties:
                  message: { type: string }
                  method: { type: string }
                  secret: { type: string }
                  qrCode: { type: string }
                  devCode: { type: string }

    delete:
      tags: [TwoFactor]
      summary: Disable 2FA
      security:
        - cookieAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/Disable2FARequest'
      responses:
        '200':
          description: 2FA disabled successfully

  /2fa/confirm:
    post:
      tags: [TwoFactor]
      summary: Confirm and Enable 2FA
      security:
        - cookieAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/Confirm2FARequest'
      responses:
        '200':
          description: 2FA enabled successfully
