services:
  nginx:
    build:
      context: .
      dockerfile: infra/nginx/Dockerfile
    container_name: nginx
    ports:
      - "8081:80"
      - "443:443"
    depends_on:
      - user-service
      - game-service
      - chat-service
    networks:
      - app-network
      - elk
    volumes:
      - nginx-logs:/var/log/nginx
    mem_limit: 64m
    mem_reservation: 32m
    cpus: 0.25
    restart: unless-stopped

  user-service:
    build: ./src/backend/user-service
    container_name: user-service
    environment:
      - NODE_ENV=development
      - PORT=3001
      - DATABASE_URL=file:/app/data/usermgmt.db
      - JWT_SEC=${JWT_SECRET:-super_secret_jwt_key_change_me_32chars}
      - COOKIE_SECRET=${COOKIE_SECRET:-super_secret_cookie_key_32chars}
      - FRONTEND_URL=https://localhost
      - BACKEND_URL=http://user-service:3001
      - EMAIL_HOST=${EMAIL_HOST:-smtp.example.com}
      - EMAIL_PORT=${EMAIL_PORT:-587}
      - EMAIL_USER=${EMAIL_USER:-noreply@example.com}
      - EMAIL_PASS=${EMAIL_PASS:-placeholder}
      - EMAIL_FROM=${EMAIL_FROM:-noreply@example.com}
      - UPLOADS_DIR=/app/public/uploads
      - NODE_OPTIONS=--max-old-space-size=200
    volumes:
      - user-data:/app/data
      - user-uploads:/app/public/uploads
    networks:
      - app-network
      - monitoring
    mem_limit: 256m
    mem_reservation: 100m
    cpus: 0.5
    restart: unless-stopped

  game-service:
    build: ./src/backend/game-service
    container_name: game-service
    environment:
      - PORT=3500
      - NODE_OPTIONS=--max-old-space-size=128
    networks:
      - app-network
    mem_limit: 180m
    mem_reservation: 64m
    cpus: 0.5
    restart: unless-stopped

  chat-service:
    build: ./src/backend/chat-service
    container_name: chat-service
    environment:
      - PORT=4000
      - DATABASE_URL=file:/app/data/chat.db
      - NODE_OPTIONS=--max-old-space-size=128
    volumes:
      - chat-data:/app/data
    networks:
      - app-network
    mem_limit: 180m
    mem_reservation: 64m
    cpus: 0.5
    restart: unless-stopped

volumes:
  nginx-logs:
    driver: local
    name: nginx-logs
  user-data:
    driver: local
  user-uploads:
    driver: local
  chat-data:
    driver: local

networks:
  app-network:
    driver: bridge
    name: network
  elk:
    driver: bridge
    name: logging
  monitoring:
    driver: bridge
    name: monitoring
